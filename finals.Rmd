---
title: "DATASCI 306, Fall 2024, Final Group Project"
author: "Group Number 25: Nico Cuccarese, Bowei Feng, Christopher Park, Freddy Quarshie"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

Throughout this course, you've dedicated yourself to refining your analytical abilities using R programming language. These skills are highly coveted in today's job market!  

Now, for the semester project, you'll apply your learning to craft a compelling `Data Story` that can enrich your portfolio and impress prospective employers. Collaborating with a team (up to 5 members of your choosing), you'll construct a Data Story akin to the example provided here: <https://ourworldindata.org/un-population-2024-revision>

Data is already in the `data` folder. This data is downloaded from: <https://population.un.org/wpp/Download/Standard/MostUsed/>

You'll conduct Exploratory Data Analysis (EDA) on the provided data. The provided article already includes 6 diagrams.  Show either the line or the map option for these 6 charts. You may ignore the table view. I'm also interested in seeing how each team will expand upon the initial analysis and generate additional 12 insightful charts that includes US and any other region or country that the author did not show.  For e.g., one question you may want to answer is; US population is expected to increase to 421 million by 2100. You may want to show how the fertility rate and migration may be contributing to this increase in population.

**Deliverable**

**1. Requirement-1 (2 pt) **
Import the data given in the .xlxs file into two separate dataframes;

* one dataframe to show data from the `Estimates` tab 
* one dataframe to show data from the `Medium variant` tab 

Hint: Some of the steps you may take while importing include:

* skip the first several comment lines in the spread sheet
* Importing the data as text first and then converting the relevant columns to different datatypes in step 2 below.

```{r}
library(readxl)
library(tidyr)
library(dplyr)
library(ggplot2)
library(scales)
library(caret)

estimates_table <- read_excel("data/WPP2024_GEN_F01_DEMOGRAPHIC_INDICATORS_COMPACT.xlsx", 
                              sheet = "Estimates", skip = 16, col_types = "text")
medium_variant_table <- read_excel("data/WPP2024_GEN_F01_DEMOGRAPHIC_INDICATORS_COMPACT.xlsx", 
                                   sheet = "Medium variant", skip = 16, col_types = "text")

```
**2. Requirement-2 (5 pt)**

You should show at least 5 steps you adopt to clean and/or transform the data. Your cleaning should include:

* Renaming column names to make it more readable; removing space, making it lowercase or completely giving a different short name; all are acceptable.
* Removing rows that are irrelevant; look at rows that have Type value as 'Label/Separator'; are those rows required?
* Removing columns that are redundant; For e.g., variant column
* Converting text values to numeric on the columns that need this transformation

You could also remove the countries/regions that you are not interested in exploring in this step and re-save a smaller file in the same `data` folder, with a different name so that working with it becomes easier going forward.

Explain your reasoning for each clean up step.
Takes in col names and gets rid of 
Load in all necessary libraries

```{r}
#Explanation: Takes in a data frames and cleans up the column names 
rename_cols <- function(df) {
  df <- df |>
    rename_with(~ gsub(" ", "_", .)) |>
    rename_with(~ gsub("[^[:alnum:]_]", "", .)) |>
    rename_with(~ tolower(.))
  return(df)
}
estimates_clean <- rename_cols(estimates_table)
medium_clean <- rename_cols(medium_variant_table)
```

```{r}
# Filters out rows where 'type' column has 'Label/Separator' to make it organized
estimates_clean <- estimates_clean[estimates_clean$type != "Label/Separator", ]
medium_clean <- medium_clean[medium_clean$type != "Label/Separator", ]
```

```{r}
#Get rid of some uneccessary rows
clean_cols <- function(df) {
  df %>% select(-c("variant", "notes", "location_code", "iso3_alphacode", 
                   "iso2_alphacode", "sdmx_code", "type", "parent_code"))
}
estimates_clean <- clean_cols(estimates_clean)
medium_clean <- clean_cols(medium_clean)
```

```{r}
#Takes in a dataframe and convert n -> N as numeric.
convert_columns_to_numeric <- function(data, n) {
  data[(n + 1):ncol(data)] <- lapply(data[(n + 1):ncol(data)], function(x) {
    as.numeric(as.character(x))
  })
  return(data)
}
estimates_clean <- convert_columns_to_numeric(estimates_clean, 3)
medium_clean <- convert_columns_to_numeric(medium_clean, 3)
```

```{r}
#Created a combined data set for easier use on certain graphs
combined_data <- bind_rows(estimates_clean, medium_clean)
```

**3.  Requirement-3 (3 pt)**
Replicate the 6 diagrams shown in the article.  Show only the '2024' projection values where ever you have both '2022' and '2024' displayed. 
Show only the diagrams that are shown on the webpage with default options.

**Graph 1:**

```{r}
medium_clean |>
  filter(region_subregion_country_or_area_ == "World") |> mutate(year = as.numeric(year)) |> ggplot(aes(x = year, y = total_population_as_of_1_january_thousands)) + geom_line(group = 1, color = "blue") + geom_point(color = "blue") +
  labs(
    title = "Total Population - World",x = "Year", y = "Population (Billions)") + scale_x_continuous(breaks = c(2024, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) +
  scale_y_continuous(breaks = c(8.5e6, 9e6, 9.5e6, 10e6), labels = c("8.5B", "9B", "9.5B", "10B"))
```

**Graph 2:**

```{r} 
#This one needs fixing
medium_clean |>
  filter(region_subregion_country_or_area_ %in% c("World", "Africa", "Asia", "Europe", "Northern America", "Latin America and the Caribbean")) |> mutate(year = as.numeric(year)) |> ggplot(aes(x = year, y = total_population_as_of_1_january_thousands)) + geom_line(group = 1, color = "blue") + geom_point(color = "blue") +
  labs(
    title = "Total Population - World",x = "Year", y = "Population (Billions)") + scale_x_continuous(breaks = c(2024, 2050, 2080)) + facet_wrap(~region_subregion_country_or_area_, scales = "free_y")
```

**Graph 3:**

```{r}
complete_data <- bind_rows(estimates_clean, medium_clean)
complete_data |>
  select(year, region_subregion_country_or_area_, total_fertility_rate_live_births_per_woman) |>
  filter(region_subregion_country_or_area_ %in% c("World", "Africa", "Asia", "Europe", "Northern America", "Latin America and the Caribbean")) |>
  ggplot(aes(x = as.numeric(year), y = total_fertility_rate_live_births_per_woman, color = region_subregion_country_or_area_)) +
  geom_line(size = .9) + # Thicker lines for better visibility
  geom_point(size = .3) + # Slightly larger points for clarity
  labs(
    title = "Total Fertility Rate Over Time",
    x = "Year",
    y = "Total Fertility Rate (Live Births per Woman)",
    color = "Region"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), 
    legend.position = "bottom",
    legend.title = element_text(size = 14), 
    legend.text = element_text(size = 12), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12) 
  ) +
  scale_y_continuous(expand = c(0.02, 0.02)) + # Remove excessive padding on y-axis
  guides(color = guide_legend(nrow = 2)) # Make the legend more compact


```

**Graph 4:**

```{r}
# Filter for India and China population data from combined_data
graph_4_data <- complete_data %>%
  filter(region_subregion_country_or_area_ %in% c("India", "China")) %>%
  mutate(
    year = as.numeric(year), # Ensure 'year' is numeric
    population_billions = total_population_as_of_1_july_thousands / 1e6 # Convert thousands to billions
  )

# Create the line graph
ggplot(graph_4_data, aes(x = year, y = population_billions, color = region_subregion_country_or_area_)) +
  geom_line(size = 1.2) + # Add lines with increased thickness
  geom_point(size = 2) + # Add larger points for better visibility
  scale_color_manual(values = c("India" = "red", "China" = "blue")) + # Custom colors for India and China
  labs(
    title = "Population Trends of India and China (1950 to 2100)",
    subtitle = "Projections from 2024 onwards based on UN's medium scenario.",
    x = "Year",
    y = "Population (Billions)",
    color = "Country"
  ) +
  scale_x_continuous(breaks = seq(1950, 2100, by = 10), expand = c(0, 0)) + # X-axis ticks every 10 years
  scale_y_continuous(breaks = seq(0, 2, by = 0.2), expand = c(0, 0)) + # Y-axis ticks every 0.2 billion
  theme_minimal(base_size = 14) + # Minimal theme with a larger base font size
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"), # Center and bold title
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "italic"), # Center and italicize subtitle
    axis.text.x = element_text(size = 12), # Larger x-axis text
    axis.text.y = element_text(size = 12), # Larger y-axis text
    legend.position = "bottom", # Place legend at the bottom
    legend.title = element_text(size = 12), # Larger legend title
    legend.text = element_text(size = 10) # Larger legend labels
  )

```

**Graph 5:**

```{r}
countries <- c("World", "Africa", "Asia", "Europe", "Northern America", "Latin America and the Caribbean")

estimates_clean |> 
  select(year, life_expectancy_at_birth_both_sexes_years, region_subregion_country_or_area_) |>
  filter(region_subregion_country_or_area_ %in% countries) |>
  ggplot(aes(
    x = as.numeric(year), 
    y = life_expectancy_at_birth_both_sexes_years, 
    color = region_subregion_country_or_area_
  )) +
  geom_point() +
  labs(
    x = "Year",
    y = "Life Expectancy (Years)",
    color = "Region"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom", # Move the legend to the bottom
    legend.title = element_text(size = 10), # Adjust legend title size
    legend.text = element_text(size = 8) # Adjust legend text size
  )

```

**Graph 6:**

```{r}
estimates_clean |>
  filter(region_subregion_country_or_area_ == "Ukraine") |>
  select(year, net_number_of_migrants_thousands) |>
  ggplot(aes(x = as.numeric(year), y = net_number_of_migrants_thousands))+ 
  geom_point() + geom_line() + scale_x_continuous(breaks = c(1950, 1960, 1970, 1980, 1990, 2000, 2010, 2023)) + labs(title = "Annual net migration in Ukraine, 1950 to 2023", x = "Year", y = "Net Migration") + scale_y_continuous(breaks = c(0, -2000, -4000), labels = c("0", "-2 Million", "-4 million"))

```

**4.  Requirement-4 (12 pt)**

Select United States related data, and any other country or region(s) of your choosing to perform EDA. Chart at least 12 additional diagrams that may show relationships like correlations, frequencies, trend charts, between various variables with plots of at least 3 different types (line, heatmap, pie, etc.). Every plot should have a title and the x/y axis should have legible labels without any label overlaps for full credit. 

Summarize your interpretations after each chart.

**Let's analyze different variables based on gender**

**Graph 1**

```{r}
estimates_clean |>
  filter(year == 2022 & region_subregion_country_or_area_ == "World") |>
  summarise(
    Male = sum(male_population_as_of_1_july_thousands),
    Female = sum(female_population_as_of_1_july_thousands)
  ) |>
  pivot_longer(cols = c(Male, Female), names_to = "Gender", values_to = "Population") |>
  mutate(Percentage = Population / sum(Population) * 100) |>
  ggplot(aes(x = "", y = Population, fill = Gender)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
            position = position_stack(vjust = 0.5), size = 5) +
  labs(
    title = "Male-to-Female Population Ratio in the World (2022)",
    fill = "Gender"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, face = "bold")
  )
```

The first graph provides a baseline overview of the global gender distribution, showing the near 50/50 split between males and females. This serves as a reference point for understanding deviations in gender ratios across different regions.

**Graph 2:**

```{r}
estimates_clean |>
  select(year, region_subregion_country_or_area_, female_population_as_of_1_july_thousands) |>
  filter(region_subregion_country_or_area_ %in% c("World", "Asia", "United States of America", "Europe")) |>
  ggplot(aes(x = as.numeric(year), y = female_population_as_of_1_july_thousands, color = region_subregion_country_or_area_)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Female Population Over Time: World, China, Usa",
    x = "Year",
    y = "Female Population (Thousands)",
    color = "Region"
  ) +
  theme_minimal()

```

The second graph highlights female population growth over the decades, segmented by region. Asia leads with the highest growth rate, mirroring broader global population trends documented by the United Nations. Europe, by contrast, shows more modest growth, reflecting slower demographic shifts in the region

**Graph 3**

```{r}
estimates_clean |>
  select(year, region_subregion_country_or_area_, male_population_as_of_1_july_thousands, female_population_as_of_1_july_thousands) |>
  filter(region_subregion_country_or_area_ %in% c("World", "Asia", "United States of America", "Europe")) |>
  pivot_longer(cols = c(male_population_as_of_1_july_thousands, female_population_as_of_1_july_thousands),
               names_to = "gender", values_to = "population") |>
  ggplot(aes(x = as.numeric(year), y = population, color = gender)) +
  geom_line(size = 1.0) +
  facet_wrap(~region_subregion_country_or_area_, scales = "free_y") +
  labs(
    title = "Male vs Female Population Over Time",
    subtitle = "Faceted by Region",
    x = "Year",
    y = "Population (Thousands)",
    color = "Gender"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "top",
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 14, face = "italic"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold")
  )
```

This graph showcases regional variations in the male-to-female population ratio. Europe stands out with a female-dominant population, likely influenced by differences in life expectancy and possibly cultural factors. In the United States, the gender ratio fluctuates notably between the 1970s and 1980s, potentially reflecting demographic shifts during the Vietnam War. Asia, on the other hand, exhibits a male-dominant ratio, which can be linked to historical factors such as the One Child Policy and cultural gender preferences.

**Graph 4:**

```{r}
estimates_clean |>
  filter(region_subregion_country_or_area_ %in% c("World", "Asia", "United States of America", "Europe")) |>
  mutate(
    male_to_female_ratio = male_population_as_of_1_july_thousands / female_population_as_of_1_july_thousands
  ) |>
  ggplot(aes(x = as.numeric(year), y = male_to_female_ratio)) +
  geom_line(size = 1.2, color = "blue") +
  facet_wrap(~region_subregion_country_or_area_) +  # Fixed y-scales
  labs(
    title = "Male-to-Female Population Ratio Over Time",
    subtitle = "Faceted by Region (World, China, USA, Europe) with Consistent Y-Axis Scaling",
    x = "Year",
    y = "Male-to-Female Ratio"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 14, face = "italic"),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold")  # Bold facet titles
  )
```

The graph shows the Male-to-Female population ratio across different regions.  In the United States, the male-to-female ratio exhibits a noticeable dip during the 1970s and 1980s, possibly linked to the Vietnam War's demographic impact, which disproportionately affected the male population. Asia consistently shows a higher male-to-female ratio, reflecting the influence of historical policies such as the One Child Policy and cultural preferences for male offspring. Meanwhile, Europe’s ratio highlights a steady surplus of females, likely due to longer female life expectancy and lower male survival rates.

Now let's look at fertility rates in different countries.

**Graph 5:**

```{r}
combined_data %>% filter(region_subregion_country_or_area_ %in% c("United States", "China", "India",  "Russia", "Japan", "South Korea", "Vietnam", "Nigeria", "Saudi Arabia")) %>% select(year, region_subregion_country_or_area_, total_fertility_rate_live_births_per_woman) %>%  ggplot(aes(x = as.numeric(year), y = region_subregion_country_or_area_, fill = total_fertility_rate_live_births_per_woman)) + geom_tile(color = "white") + scale_fill_viridis_c(option = "magma", name = "Fertility Rate") +labs(title = "Fertility Rate Heatmap (1950-2100)", x = "Year", y = "Country") + theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

*The heat map displays the fertility rates of these randomly selected countries in the Eastern world: Saudi Arabia, Nigeria, Japan, India, and China from 1950 - 2100. The colors from darkest to lightest represent the lowest to highest fertility rate numerical values (dark purple/black to light yellow/pink). Based on the heatmap, Japan tends to have the lowest fertility rate, showing darker shades of purple from 1950 to 2100. Meanwhile, Nigeria had the highest fertility rate of roughly six from 1950 to mid-2020 but was on the trend to decrease to nearly 2 in 2100. On the other hand, China is following in Japan’s footsteps, where its fertility rate has been increasing by almost two from the present to 2100. However, it used to have high fertility rates due to the country’s past economic difficulties in the 1950s-70s. Lastly, Saudi Arabia had the highest fertility rate of nearly 8 in 1950 but it started to decrease rapidly in the late 70s and early 80s, when their oil started to become commodified in the global market, promoting high economic growth and urbanization, leading their fertility rate to being nearly 2 in 2100. So, this heat map shows the range of fertility rates and their changes over time in these specific countries. 

**Graph 6:**

```{r}
medium_clean %>% filter(year == 2100, region_subregion_country_or_area_ %in% c("Northern America", "Asia", "Europe", "Africa", "Latin America and the Caribbean")) %>%  group_by(region_subregion_country_or_area_) %>%
 summarize(avg_fertility_rate = mean(total_fertility_rate_live_births_per_woman, na.rm = TRUE)) %>%
ggplot(aes(x = region_subregion_country_or_area_, y = avg_fertility_rate, fill = region_subregion_country_or_area_)) + geom_bar(stat = "identity", width = 0.6) + labs(title = "Fertility Rates in Major Continents in 2100", x = "Continents", y = "Fertility Rate (Live Births per Woman)", fill = "Continents") + theme_minimal() + theme(
    axis.text.x = element_blank() # Removes x-axis text
  )
```

The bar chart compares fertility rates (live births per woman) by continent in 2100 between Africa, Asia, and Europe. From this figure, in the year 2100, the fertility rate for Africa is 2.0, Asia is 1.75, and Europe is 1.6. In simpler terms, Africa has the highest fertility rate while Europe has the lowest. These numerical values for the fertility rates of these continents are roughly around the replacement level fertility rate, which is approximately 2.1 live births per woman to sustain the population. However, Asia and Europe will see a declining fertility rate because their fertility rate is lower than the replacement level. At the same time, Africa will stabilize since it is close to 2.1 births per woman in 2100. These findings may include the assumption that these continents have become so advanced economically, socially, and technologically that the fertility rate of these continents will decline rapidly, given its expected results in 2100. 


**Graph 7:**

```{r}
estimates_clean %>%
 filter(region_subregion_country_or_area_ %in% c("United States of America", "India")) %>%
select(year, region_subregion_country_or_area_, total_fertility_rate_live_births_per_woman) %>%
ggplot(aes(x = as.numeric(year),  y = total_fertility_rate_live_births_per_woman, color = region_subregion_country_or_area_)) + geom_line(size = 1) +  labs(title = "Trends in Fertility Rates Over Time: United States vs. India", x = "Year", y = "Fertility Rate (Live Births per Woman)", color = "Country") + theme_minimal()
```

*The line chart compares the fertility rates in the US and India from the 1950s to the 2020s (Live births per woman). The US and India are among the most highly populated countries in the world. In 1950, India had a fertility rate of roughly 6, while the US had 3. However, in the early to mid-1960s, fertility rates in the US and India peaked at their highest level but slowly declined afterward. The fertility rate of the US significantly decreased from 1960 to the late 1970s due to its involvement in the Vietnam War. Still, it started to stabilize in the 1980s-90s when it experienced economic growth, urbanization, and modernization of societal norms. Meanwhile, India has steadily decreased as the country experienced economic growth, more educational opportunities, and urbanization, but it currently goes through health issues like obesity, smoking, and air pollution. As of 2020, the fertility rate in the US is roughly 1.6, while in India, it is 2. So it is interesting to see the trends in the fertility rate of both countries, which tend to have the highest population in the world.  

**Graph 8:**

```{r}
medium_clean |>
  filter(region_subregion_country_or_area_ == "World") |> mutate(year = as.numeric(year)) |> ggplot(aes(x = year, y = crude_death_rate_deaths_per_1000_population)) + geom_line(group = 1, color = "blue") + geom_point(color = "blue") +
  labs(
    title = "Death Rate - World",x = "Year", y = "Deaths per 1000 People") + scale_x_continuous(breaks = c(2024, 2030, 2040, 2050, 2060, 2070, 2080, 2090, 2100)) +
  theme_minimal()
```

This chart shows that the UN projection of the world’s death rate is a steady increase from now until 2100. My interpretation is that this is because as the world’s population increases, there will also be more people susceptible to dying, especially elderly people. Also, we are heading towards a point where the world’s population will peak, so as we approach that point, the death rate should be increasing faster than the birth rate and part of that is reflected by the consistent increase in the graph.

**Graph 9:**

```{r}
combined_data |>
  select(year, region_subregion_country_or_area_, crude_death_rate_deaths_per_1000_population) |>
  filter(region_subregion_country_or_area_ %in% c("World", "Africa", "Asia", "Europe", "Northern America", "Latin America and the Caribbean")) |>
  ggplot(aes(x = as.numeric(year), y = crude_death_rate_deaths_per_1000_population, color = region_subregion_country_or_area_)) +
  geom_line(size = .9) + 
  geom_point(size = .3) +
  labs(
    title = "Death Rate Over Time",
    x = "Year",
    y = "Deaths per 1000 People)",
    color = "Region"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), 
    legend.position = "bottom",
    legend.title = element_text(size = 14), 
    legend.text = element_text(size = 12), 
    axis.text.x = element_text(size = 12), 
    axis.text.y = element_text(size = 12) 
  ) +
  scale_y_continuous(expand = c(0.02, 0.02)) + 
  guides(color = guide_legend(nrow = 2))

```

This graph shows the death rate over time for each continent and the world from 1950 to the projected death rate in 2100. Just like the fertility graph presented in the article, there is a large variation in the death rates in 1950, but the variation decreases as we approach 2100. I believe this is because as time goes on, the death rates of all the regions and continents are converging towards the average death rate of the world. Another interesting finding is that you can see spikes in the chart that represent times when the death rate unusually increased. For example, all the lines have spikes around 2020 because this is when the COVID-19 pandemic was happening.

**Graph 10:**

```{r}
estimates_clean %>% 
  filter(year == "2023", region_subregion_country_or_area_ %in% c("Northern America", "Asia", "Europe", "Africa", "Latin America and the Caribbean")) %>%  
  group_by(region_subregion_country_or_area_) %>%
 summarize(avg_death_rate = mean(crude_death_rate_deaths_per_1000_population, na.rm = TRUE)) %>%
ggplot(aes(x = region_subregion_country_or_area_, y = avg_death_rate, fill = region_subregion_country_or_area_)) + 
  geom_bar(stat = "identity", width = 0.6) + labs(title = "Death Rates in Major Continents in 2023", x = NULL, y = "Deaths per 1000 People", fill = "Continent") + 
  theme_minimal() +
  theme(axis.text.x = element_blank(),
  axis.ticks.x = element_blank()) +
  scale_y_continuous(breaks = seq(0, 12, by = 2))
```

This graph shows the death rate for each continent in the year 2023. I think it’s interesting how Europe has a much higher death rate than all the other groups, despite its advances in health and technology. I believe that because of those advances, Europe has an aging population that is now dying off and increasing the death rate.  

**Graph 11:**

```{r}
# Filter estimates_clean for Afghanistan, Iran, and Viet Nam
selected_countries_data <- estimates_clean %>%
  filter(
    region_subregion_country_or_area_ %in% c("Afghanistan", "Iran (Islamic Republic of)", "Viet Nam"),
    year >= 1950 & year <= 2024  # Filter for valid years
  ) %>%
  select(region_subregion_country_or_area_, year, life_expectancy_at_age_65_both_sexes_years) %>%
  mutate(
    year = as.numeric(year),  # Convert year to numeric
    life_expectancy = as.numeric(life_expectancy_at_age_65_both_sexes_years)  # Convert life expectancy to numeric
  ) %>%
  filter(!is.na(life_expectancy))  # Remove rows with NA values

# Create the line plot for Afghanistan, Iran, and Viet Nam
ggplot(selected_countries_data, aes(x = year, y = life_expectancy, color = region_subregion_country_or_area_)) +
  geom_line(linewidth = 1.5) +  # Line with custom width
  geom_point(size = 2) +  # Add points for emphasis
  labs(
    title = "Life Expectancy at Age 65 in Afghanistan,\nIran, and Viet Nam (1950-2024)",
    subtitle = "Trends over time reflect significant historical events.",
    x = "Year",
    y = "Life Expectancy (Years)",
    color = "Country"
  ) +
  scale_x_continuous(breaks = seq(1950, 2025, by = 5)) +  # X-axis ticks every 5 years
  scale_y_continuous(limits = c(6, 20), breaks = seq(6, 20, by = 2)) +  # Y-axis range 6–20, ticks every 2
  scale_color_manual(
    values = c("Afghanistan" = "red", "Iran (Islamic Republic of)" = "blue", "Viet Nam" = "orange")
  ) +  # Custom colors
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "italic"),
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate X-axis labels
    legend.position = "bottom"  # Place legend at the bottom
  )

```

This graph highlights the trends in life expectancy at age 65 in Afghanistan, Iran, and Viet Nam from 1950 to 2024, reflecting significant historical and social events. Afghanistan's life expectancy exhibits sharp declines during periods of conflict, such as the Soviet-Afghan War (1980s) and the post-2001 war, emphasizing the devastating impacts of prolonged violence. Iran (Islamic Republic of) shows a steady increase in life expectancy, with slight stagnation during the Iran-Iraq War (1980-1988), illustrating resilience despite geopolitical challenges. Viet Nam demonstrates rapid improvements, particularly after the Vietnam War (1955-1975) and economic reforms (Doi Moi) in the late 1980s, indicating recovery and development post-conflict. These patterns underscore the profound influence of wars, recovery, and socio-economic progress on health and longevity.

**Graph 12:**

```{r}

# Filter estimates_clean for Bangladesh, China, and Haiti
disaster_countries_data <- estimates_clean %>%
  filter(
    region_subregion_country_or_area_ %in% c("Bangladesh", "China", "Haiti"),
    year >= 1950 & year <= 2024  # Filter for valid years
  ) %>%
  select(region_subregion_country_or_area_, year, life_expectancy_at_birth_both_sexes_years) %>%
  mutate(
    year = as.numeric(year),  # Convert year to numeric
    life_expectancy = as.numeric(life_expectancy_at_birth_both_sexes_years)  # Convert life expectancy to numeric
  ) %>%
  filter(!is.na(life_expectancy))  # Remove rows with NA values

# Create the line plot for Bangladesh, China, and Haiti
ggplot(disaster_countries_data, aes(x = year, y = life_expectancy, color = region_subregion_country_or_area_)) +
  geom_line(linewidth = 1.5) +  # Line with custom width
  geom_point(size = 2) +  # Add points for emphasis
  labs(
    title = "Life Expectancy at Birth in Bangladesh, \nChina, and Haiti (1950-2024)",
    subtitle = "Highlights the impact of major natural disasters on life expectancy.",
    x = "Year",
    y = "Life Expectancy (Years)",
    color = "Country"
  ) +
  scale_x_continuous(breaks = seq(1950, 2025, by = 5)) +  # X-axis ticks every 5 years
  scale_y_continuous(limits = c(30, 80), breaks = seq(30, 80, by = 10)) +  # Y-axis range 30–80, ticks every 10
  scale_color_manual(
    values = c("Bangladesh" = "green", "China" = "blue", "Haiti" = "orange")
  ) +  # Custom colors
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "italic"),
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate X-axis labels
    legend.position = "bottom"  # Place legend at the bottom
  )
```

This graph illustrates the life expectancy at birth in Bangladesh, China, and Haiti from 1950 to 2024, highlighting the profound impact of major natural disasters. In Bangladesh, the sharp decline around 1970 corresponds to the Bhola Cyclone, which claimed over 300,000 lives, demonstrating the devastating toll of this event. China's decline in the early 1960s reflects the aftermath of the Great Chinese Famine (1959–1961), exacerbated by natural disasters and policy failures, resulting in millions of deaths. In Haiti, the sharp drop in 2010 is associated with the catastrophic Haiti Earthquake, which killed between 100,000 and 316,000 people, emphasizing the vulnerability of highly populated regions with inadequate infrastructure. Despite these disruptions, the long-term trends show resilience and recovery in all three countries.


**5. Requirement-5 (2 pt)**
Having developed a strong understanding of your data, you'll now create a machine learning (ML) model to predict a specific metric. This involves selecting the most relevant variables from your dataset.

The UN's World Population Prospects provides a range of projected scenarios of population change. These rely on different assumptions in fertility, mortality and/or migration patterns to explore different demographic futures. Check this link for more info: https://population.un.org/wpp/DefinitionOfProjectionScenarios

You can choose to predict the same metric the UN provides (e.g., future population using fertility, mortality, and migration data). Compare your model's predictions to the UN's. 

How significantly do your population projections diverge from those of the United Nations? Provide a comparison of the two.  If you choose a different projection for which there is no UN data to compare with, then this comparison is not required.

```{r}
# Filter the dataset for training (1950-2022)
training_data <- selected_countries_data %>%
  filter(year >= 1950 & year <= 2022)

# Split data into training and testing sets
set.seed(123)  # Set seed for reproducibility
train_index <- createDataPartition(training_data$life_expectancy, p = 0.8, list = FALSE)
train_set <- training_data[train_index, ]
test_set <- training_data[-train_index, ]

# Fit a linear regression model
life_expectancy_model <- lm(life_expectancy ~ year + region_subregion_country_or_area_, data = train_set)

# Model summary
summary(life_expectancy_model)

# Predict on the test set
test_set$predicted_life_expectancy <- predict(life_expectancy_model, newdata = test_set)

# Evaluate the model
model_performance <- data.frame(
  RMSE = RMSE(test_set$predicted_life_expectancy, test_set$life_expectancy),
  R2 = R2(test_set$predicted_life_expectancy, test_set$life_expectancy)
)
print(model_performance)

# Visualize predictions vs. actuals
ggplot(test_set, aes(x = life_expectancy, y = predicted_life_expectancy, color = region_subregion_country_or_area_)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +  # Line of perfect prediction
  labs(
    title = "Predicted vs. Actual Life Expectancy at Age 65",
    x = "Actual Life Expectancy (Years)",
    y = "Predicted Life Expectancy (Years)",
    color = "Country"
  ) +
  theme_minimal(base_size = 14)

# Predict for the entire dataset (including 2023-2024 for comparison with UN data)
selected_countries_data$predicted_life_expectancy <- predict(life_expectancy_model, newdata = selected_countries_data)

# Plot predictions vs. UN estimates
ggplot(selected_countries_data, aes(x = year)) +
  geom_line(aes(y = life_expectancy, color = region_subregion_country_or_area_), size = 1.2) +
  geom_line(aes(y = predicted_life_expectancy, color = region_subregion_country_or_area_), linetype = "dashed") +
  labs(
    title = "Comparison of Predicted vs. UN Life Expectancy at Age 65",
    subtitle = "Predicted values from linear regression model.",
    x = "Year",
    y = "Life Expectancy (Years)",
    color = "Country"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "italic"),
    legend.position = "bottom"
  )


```


**6.  Requirement-5 (1 pt)**

**Conclusion**

Your analysis should conclude with a summary of key findings. I'm especially interested in any novel insights you uncover that go beyond the article's original conclusions.

**7. Extra Credit (1 pt)**
Develop an interactive Shiny app to visualize your machine learning model's projections. The app must include at least one interactive widget (e.g., dropdown, radio buttons, text input) allowing users to select a variable value (such as country/region) and view the corresponding projections.


**Submission**

* You will upload the zip file containing finals.Rmd file and its PDF as a deliverable to Canvas. If you created a shiny app for predictions, you will add those files also to your zip file.

* You will present your findings by creating a video of a maximum 15 minutes duration, explaining the code and the workings of your project; all team members should explain their part in the project to receive credit. You will share the URL of the video on Canvas for us to evaluate. An ideal way to create this video would be to start a Zoom meeting, start recording, and then every member share their screen and explain their contribution.


It is not necessary to prepare slides (if you do it doesn't hurt) for the presentation. You may speak by showing the diagrams and/or code from your Posit project.  Every team member should explain their part in the project along with the insights they derived by explaining the charts and summaries for full credit to each member.

Your project will be evaluated for clean code, meaningful/insightful EDA and predictions.

**Note:**

* Each plot must be accompanied by a summary that clarifies the rationale behind its creation and what insights the plot unveils. Every diagram should possess standalone significance, revealing something more compelling than the other charts
* After the deadline, instructors will select the top three outstanding analytics projects. The teams responsible for these exceptional analyses will have their video shared with the class

**We will not accept submissions after the deadline; December 10th 4 pm**



